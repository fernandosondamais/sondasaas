<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SondaSaaS - Gestão Administrativa</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --sonda-green: #8CBF26;
            --sonda-dark-green: #6a9615;
            --sonda-blue: #003366;
        }

        body { background-color: #f4f6f9; font-family: 'Segoe UI', sans-serif; }

        /* Navbar Compacta (Pedido do Fabiano) */
        .navbar-admin {
            background: linear-gradient(90deg, var(--sonda-blue) 0%, #004080 100%);
            padding: 10px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .brand-text { color: white; font-weight: 700; font-size: 1.2rem; margin-left: 10px; }
        .btn-logout { background-color: rgba(255,255,255,0.1); color: white; border: none; }
        .btn-logout:hover { background-color: rgba(255,255,255,0.2); color: white; }

        /* Cards de KPIs */
        .kpi-card {
            background: white; border: none; border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: transform 0.2s;
            border-left: 5px solid var(--sonda-green);
        }
        .kpi-card:hover { transform: translateY(-3px); }
        .kpi-title { font-size: 0.8rem; color: #6c757d; text-transform: uppercase; font-weight: 600; }
        .kpi-value { font-size: 1.8rem; font-weight: 700; color: var(--sonda-blue); }

        /* Tabela */
        .table-container {
            background: white; padding: 25px; border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-top: 20px;
        }
        .table thead th {
            background-color: #f8f9fa; color: var(--sonda-blue);
            font-weight: 600; font-size: 0.85rem; border: none;
        }
        .table tbody td { vertical-align: middle; font-size: 0.9rem; color: #444; }
        
        .contact-info { font-size: 0.8rem; color: #666; }
        .contact-info i { width: 15px; color: var(--sonda-green); }

        .btn-action { padding: 4px 8px; font-size: 0.8rem; border-radius: 4px; }
    </style>
</head>
<body>

    <nav class="navbar navbar-admin fixed-top">
        <div class="container-fluid px-4">
            <div class="d-flex align-items-center">
                <i class="fas fa-chart-line text-white"></i>
                <span class="brand-text">Painel Gerencial SondaMais</span>
            </div>
            <div class="d-flex gap-2">
                <a href="/" class="btn btn-logout btn-sm"><i class="fas fa-plus"></i> Novo Orçamento</a>
                <a href="/logout" class="btn btn-logout btn-sm"><i class="fas fa-sign-out-alt"></i> Sair</a>
            </div>
        </div>
    </nav>

    <div class="container" style="margin-top: 80px;">
        
        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <div class="card kpi-card p-3">
                    <div class="kpi-title">Propostas Emitidas</div>
                    <div class="kpi-value" id="kpiCount">0</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card kpi-card p-3" style="border-left-color: #003366;">
                    <div class="kpi-title">Metragem Total (m)</div>
                    <div class="kpi-value" id="kpiMetragem">0 m</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card kpi-card p-3" style="border-left-color: #cc0000;">
                    <div class="kpi-title">Valor Total Ofertado</div>
                    <div class="kpi-value" id="kpiValor">R$ 0,00</div>
                </div>
            </div>
        </div>

        <div class="table-container">
            <h5 class="mb-4 text-secondary">Histórico de Propostas</h5>
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>DATA</th>
                            <th>CLIENTE / CONTATO</th>
                            <th>LOCAL DA OBRA</th>
                            <th class="text-center">FUROS</th>
                            <th class="text-end">TOTAL (R$)</th>
                            <th class="text-center">AÇÕES</th>
                        </tr>
                    </thead>
                    <tbody id="listaPropostas">
                        <tr><td colspan="7" class="text-center py-4">Carregando dados...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        async function carregarPropostas() {
            try {
                const res = await fetch('/api/propostas');
                if (res.status === 403) { window.location.href = '/login'; return; }
                
                const propostas = await res.json();
                const tbody = document.getElementById('listaPropostas');
                tbody.innerHTML = '';

                let totalMetros = 0;
                let totalValor = 0;

                propostas.forEach(p => {
                    // Atualiza KPIs
                    totalMetros += parseFloat(p.metragem_total || 0);
                    totalValor += parseFloat(p.valor_total || 0);

                    // Formata Data
                    const dataFormatada = new Date(p.data_criacao).toLocaleDateString('pt-BR');

                    // Formata Contato (Telefone/Email)
                    let contatoHtml = `<div class="fw-bold text-dark">${p.cliente}</div>`;
                    if(p.telefone) contatoHtml += `<div class="contact-info"><i class="fas fa-phone"></i> ${p.telefone}</div>`;
                    if(p.email) contatoHtml += `<div class="contact-info"><i class="fas fa-envelope"></i> ${p.email}</div>`;

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>#${p.id}</td>
                        <td>${dataFormatada}</td>
                        <td>${contatoHtml}</td>
                        <td><small>${p.endereco}</small></td>
                        <td class="text-center"><span class="badge bg-light text-dark border">${p.furos}</span></td>
                        <td class="text-end fw-bold text-success">R$ ${parseFloat(p.valor_total).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                        <td class="text-center">
                            <a href="/reemitir-pdf/${p.id}" class="btn btn-outline-primary btn-action" title="Baixar PDF"><i class="fas fa-download"></i></a>
                            <button onclick="excluir(${p.id})" class="btn btn-outline-danger btn-action" title="Excluir"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

                // Atualiza Cards
                document.getElementById('kpiCount').innerText = propostas.length;
                document.getElementById('kpiMetragem').innerText = totalMetros.toFixed(1) + ' m';
                document.getElementById('kpiValor').innerText = totalValor.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});

                if (propostas.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted">Nenhuma proposta encontrada.</td></tr>';
                }

            } catch (err) {
                console.error(err);
                document.getElementById('listaPropostas').innerHTML = '<tr><td colspan="7" class="text-center text-danger">Erro ao carregar dados.</td></tr>';
            }
        }

        async function excluir(id) {
            if (!confirm('Tem certeza que deseja excluir esta proposta?')) return;
            try {
                await fetch(`/api/propostas/${id}`, { method: 'DELETE' });
                carregarPropostas();
            } catch (err) { alert('Erro ao excluir'); }
        }

        // Carrega ao iniciar
        carregarPropostas();
    </script>
</body>
</html>