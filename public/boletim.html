<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Boletim Campo NBR</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background: #f4f4f4; padding-bottom: 100px; font-family: 'Segoe UI', sans-serif; }
        .header { background: #2c3e50; color: white; padding: 15px; position: sticky; top: 0; z-index: 1000; }
        .card-obra { border-left: 5px solid #8CBF26; margin-bottom: 10px; cursor: pointer; }
        .btn-action { height: 55px; width: 100%; border-radius: 8px; font-weight: bold; font-size: 1.1rem; margin-top: 10px; }
        .input-big { height: 60px; font-size: 1.4rem; text-align: center; font-weight: bold; }
        .tag-solo { border: 1px solid #ccc; background: white; padding: 8px 12px; border-radius: 20px; display: inline-block; margin: 2px; cursor: pointer; }
        .tag-solo:active { background: #8CBF26; color: white; }
        .tela { display: none; }
        .tela.ativa { display: block; }
    </style>
</head>
<body>

    <div id="tela-obras" class="tela ativa">
        <div class="header d-flex justify-content-between">
            <span class="fw-bold">Minhas Obras</span>
            <button class="btn btn-sm btn-outline-light" onclick="loadObras()"><i class="bi bi-arrow-clockwise"></i></button>
        </div>
        <div class="container mt-3" id="lista-obras">Loading...</div>
    </div>

    <div id="tela-furos" class="tela">
        <div class="header d-flex align-items-center gap-3">
            <i class="bi bi-arrow-left fs-4" onclick="voltar('tela-obras')"></i>
            <h6 class="m-0 text-truncate fw-bold" id="nome-obra">...</h6>
        </div>
        <div class="container mt-3">
            <button class="btn btn-success btn-action shadow" onclick="novoFuro()">+ NOVO FURO</button>
            <div id="lista-furos" class="mt-3"></div>
        </div>
    </div>

    <div id="tela-coleta" class="tela">
        <div class="header d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-2">
                <i class="bi bi-arrow-left fs-4" onclick="voltar('tela-furos')"></i>
                <div>
                    <div class="fw-bold" id="nome-furo">SP-XX</div>
                    <small class="text-warning" id="prox-metro">Próx: 1m</small>
                </div>
            </div>
            <button class="btn btn-outline-warning btn-sm" onclick="modalFim()">Finalizar</button>
        </div>

        <div class="container mt-3">
            <div class="card shadow-sm border-0 mb-3">
                <div class="card-body">
                    <label class="small fw-bold text-muted">GOLPES (1º / 2º / 3º)</label>
                    <div class="row g-2 mb-3">
                        <div class="col-4"><input type="number" id="g1" class="form-control input-big" placeholder="-"></div>
                        <div class="col-4"><input type="number" id="g2" class="form-control input-big" placeholder="-"></div>
                        <div class="col-4"><input type="number" id="g3" class="form-control input-big" placeholder="-"></div>
                    </div>

                    <label class="small fw-bold text-muted">DESCRIÇÃO DO SOLO</label>
                    <div class="mb-2">
                        <span class="tag-solo" onclick="addTag('Argila')">Argila</span>
                        <span class="tag-solo" onclick="addTag('Areia')">Areia</span>
                        <span class="tag-solo" onclick="addTag('Silte')">Silte</span>
                        <span class="tag-solo" onclick="addTag('Vermelha')">Vermelha</span>
                        <span class="tag-solo" onclick="addTag('Amarela')">Amarela</span>
                        <span class="tag-solo" onclick="addTag('Cinza')">Cinza</span>
                        <span class="tag-solo" onclick="addTag('Variegada')">Variegada</span>
                        <span class="tag-solo" onclick="addTag('Rija')">Rija</span>
                        <span class="tag-solo" onclick="addTag('Mole')">Mole</span>
                        <span class="tag-solo" onclick="addTag('Compacta')">Compacta</span>
                    </div>
                    <textarea id="desc" class="form-control mb-3" rows="2" placeholder="Ex: Argila siltosa vermelha..."></textarea>

                    <div class="d-flex gap-2">
                        <button class="btn btn-primary btn-action w-25" onclick="document.getElementById('cam').click()"><i class="bi bi-camera"></i></button>
                        <input type="file" id="cam" accept="image/*" class="d-none" onchange="uploadFoto()">
                        <button class="btn btn-success btn-action w-75" onclick="salvarAmostra()">SALVAR METRO</button>
                    </div>
                </div>
            </div>

            <h6 class="ms-2 small text-muted">HISTÓRICO</h6>
            <div class="list-group" id="historico"></div>
        </div>
    </div>

    <div class="modal fade" id="modalFim">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title">Dados Finais (NBR 6484)</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="fw-bold">Nível D'água Inicial (m)</label>
                        <input type="number" id="na_ini" class="form-control input-big" placeholder="0.00">
                        <small class="text-muted">Deixe em branco se não atingiu.</small>
                    </div>
                    <div class="mb-3">
                        <label class="fw-bold">Nível D'água 24h (m)</label>
                        <input type="number" id="na_fim" class="form-control input-big" placeholder="0.00">
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <label>Data Início</label>
                            <input type="date" id="dt_ini" class="form-control">
                        </div>
                        <div class="col-6">
                            <label>Data Fim</label>
                            <input type="date" id="dt_fim" class="form-control">
                        </div>
                    </div>
                    <div class="mt-3">
                        <label>Coordenadas / Obs</label>
                        <input type="text" id="coords" class="form-control" placeholder="UTM ou Lat/Long">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-dark w-100 fw-bold" onclick="salvarFim()">SALVAR E SAIR</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let obraId, furoId, nextProf = 1;

        // NAV
        function mostrar(t) { document.querySelectorAll('.tela').forEach(x=>x.classList.remove('ativa')); document.getElementById(t).classList.add('ativa'); }
        function voltar(t) { if(t==='tela-obras') loadObras(); mostrar(t); }

        // OBRAS
        function loadObras() {
            fetch('/api/propostas').then(r=>r.json()).then(d=>{
                const l = document.getElementById('lista-obras'); l.innerHTML='';
                d.forEach(o => l.innerHTML += `<div class="card card-obra shadow-sm" onclick="entrarObra(${o.id}, '${o.cliente}')"><div class="card-body fw-bold">${o.cliente}<br><small class="fw-normal text-muted">${o.endereco}</small></div></div>`);
            });
        }
        function entrarObra(id, nome) { obraId=id; document.getElementById('nome-obra').innerText=nome; mostrar('tela-furos'); loadFuros(); }

        // FUROS
        function loadFuros() {
            fetch(`/api/boletim/furos/${obraId}`).then(r=>r.json()).then(d=>{
                const l = document.getElementById('lista-furos'); l.innerHTML='';
                d.forEach(f => l.innerHTML += `<div class="card mb-2 shadow-sm" onclick="entrarFuro(${f.id}, '${f.nome_furo}')"><div class="card-body d-flex justify-content-between fw-bold"><span>${f.nome_furo}</span><i class="bi bi-chevron-right"></i></div></div>`);
            });
        }
        function novoFuro() {
            const n = prompt('Nome do Furo (Ex: SP-01):', 'SP-');
            if(n) fetch('/api/boletim/furos', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({proposta_id:obraId, nome_furo:n, sondador:'App', data_inicio:new Date(), nivel_agua_inicial:null})}).then(r=>r.json()).then(d=>entrarFuro(d.id, n));
        }
        function entrarFuro(id, nome) { furoId=id; document.getElementById('nome-furo').innerText=nome; mostrar('tela-coleta'); loadDados(); }

        // DADOS
        function loadDados() {
            fetch(`/api/boletim/amostras/${furoId}`).then(r=>r.json()).then(d=>{
                const l = document.getElementById('historico'); l.innerHTML='';
                let max=0;
                d.forEach(a=>{ max=parseFloat(a.profundidade_ini); l.innerHTML = `<div class="list-group-item d-flex justify-content-between"><strong>${max.toFixed(0)}m</strong><span>${a.golpe_1}/${a.golpe_2}/${a.golpe_3}</span></div>`+l.innerHTML; });
                nextProf = max+1; document.getElementById('prox-metro').innerText = `Próx: ${nextProf}m`;
                ['g1','g2','g3','desc'].forEach(i=>document.getElementById(i).value='');
            });
            fetch(`/api/boletim/furos/${obraId}`).then(r=>r.json()).then(d=>{
                const f = d.find(x=>x.id==furoId);
                if(f) { 
                    document.getElementById('na_ini').value = f.nivel_agua_inicial; 
                    document.getElementById('na_fim').value = f.nivel_agua_final; 
                    if(f.data_inicio) document.getElementById('dt_ini').value = f.data_inicio.split('T')[0];
                    if(f.data_termino) document.getElementById('dt_fim').value = f.data_termino.split('T')[0];
                    document.getElementById('coords').value = f.coordenadas;
                }
            });
        }

        function addTag(t) { const el=document.getElementById('desc'); el.value = el.value ? el.value+' '+t.toLowerCase() : t; }
        
        function salvarAmostra() {
            const g1=document.getElementById('g1').value, g2=document.getElementById('g2').value, g3=document.getElementById('g3').value;
            if(!g1 || !g2 || !g3) return alert('Preencha os 3 golpes!');
            
            fetch('/api/boletim/amostras', {
                method:'POST', headers:{'Content-Type':'application/json'}, 
                body:JSON.stringify({furo_id:furoId, profundidade_ini:nextProf, profundidade_fim:nextProf+0.45, golpe_1:g1, golpe_2:g2, golpe_3:g3, tipo_solo:document.getElementById('desc').value})
            }).then(()=>loadDados());
        }

        function uploadFoto() {
            const f = document.getElementById('cam').files[0];
            if(f) {
                const r = new FileReader();
                r.onload = e => fetch('/api/boletim/fotos', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({furo_id:furoId, imagem_base64:e.target.result, legenda:`Prof: ${nextProf}m`})}).then(()=>alert('Foto Salva!'));
                r.readAsDataURL(f);
            }
        }

        function modalFim() { new bootstrap.Modal('#modalFim').show(); }
        
        function salvarFim() {
            const dados = {
                nivel_agua_inicial: document.getElementById('na_ini').value || null,
                nivel_agua_final: document.getElementById('na_fim').value || null,
                data_inicio: document.getElementById('dt_ini').value || null,
                data_termino: document.getElementById('dt_fim').value || null,
                coordenadas: document.getElementById('coords').value || ''
            };
            fetch(`/api/boletim/furos/${furoId}`, {method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(dados)})
            .then(()=>{ alert('Dados Técnicos Salvos!'); location.reload(); });
        }

        loadObras();
    </script>
</body>
</html>