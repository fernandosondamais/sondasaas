<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Boletim Campo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background: #f8f9fa; padding-bottom: 80px; font-family: sans-serif; }
        .header-app { background: #333; color: white; padding: 15px; position: sticky; top: 0; z-index: 1000; }
        .btn-big { height: 55px; font-weight: bold; font-size: 1.1rem; width: 100%; border-radius: 10px; margin-bottom: 10px; }
        .card-obra { border-left: 5px solid #8CBF26; margin-bottom: 10px; cursor: pointer; }
        .input-big { height: 60px; font-size: 1.5rem; text-align: center; font-weight: bold; }
        .tag-solo { background: white; border: 1px solid #ccc; padding: 8px 12px; border-radius: 20px; margin: 3px; display: inline-block; cursor: pointer; }
        .tag-solo:active { background: #8CBF26; color: white; }
        .tela { display: none; }
        .tela.ativa { display: block; }
    </style>
</head>
<body>

    <div id="tela-obras" class="tela ativa">
        <div class="header-app d-flex justify-content-between">
            <span class="fw-bold">Minhas Obras</span>
            <button class="btn btn-sm btn-outline-light" onclick="carregarObras()"><i class="bi bi-arrow-clockwise"></i></button>
        </div>
        <div class="container mt-3" id="lista-obras">Carregando...</div>
    </div>

    <div id="tela-furos" class="tela">
        <div class="header-app d-flex align-items-center gap-3">
            <i class="bi bi-arrow-left fs-4" onclick="voltar('tela-obras')"></i>
            <h6 class="m-0 text-truncate fw-bold" id="titulo-obra">...</h6>
        </div>
        <div class="container mt-3">
            <button class="btn btn-success btn-big shadow" onclick="abrirNovoFuro()">+ NOVO FURO</button>
            <div id="lista-furos"></div>
        </div>
    </div>

    <div id="tela-coleta" class="tela">
        <div class="header-app d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-2">
                <i class="bi bi-arrow-left fs-4" onclick="voltar('tela-furos')"></i>
                <div>
                    <div class="fw-bold" id="titulo-furo">...</div>
                    <small class="text-warning" id="prof-atual">Próx: 1.0m</small>
                </div>
            </div>
            <button class="btn btn-outline-warning btn-sm" onclick="modalFim()">Finalizar</button>
        </div>

        <div class="container mt-3">
            <div class="card shadow-sm mb-3">
                <div class="card-body">
                    <label class="fw-bold text-muted small">GOLPES (1º / 2º / 3º)</label>
                    <div class="row g-2 mb-3">
                        <div class="col-4"><input type="tel" id="g1" class="form-control input-big" placeholder="-"></div>
                        <div class="col-4"><input type="tel" id="g2" class="form-control input-big" placeholder="-"></div>
                        <div class="col-4"><input type="tel" id="g3" class="form-control input-big" placeholder="-"></div>
                    </div>

                    <label class="fw-bold text-muted small">SOLO</label>
                    <div class="mb-2" id="tags">
                        <span class="tag-solo" onclick="addSolo('Argila')">Argila</span>
                        <span class="tag-solo" onclick="addSolo('Areia')">Areia</span>
                        <span class="tag-solo" onclick="addSolo('Silte')">Silte</span>
                        <span class="tag-solo" onclick="addSolo('Vermelha')">Vermelha</span>
                        <span class="tag-solo" onclick="addSolo('Amarela')">Amarela</span>
                        <span class="tag-solo" onclick="addSolo('Cinza')">Cinza</span>
                    </div>
                    <textarea id="solo" class="form-control mb-3" rows="2"></textarea>

                    <div class="row g-2">
                        <div class="col-4">
                            <button class="btn btn-primary btn-big" onclick="document.getElementById('cam').click()"><i class="bi bi-camera"></i></button>
                            <input type="file" id="cam" accept="image/*" class="d-none" onchange="foto()">
                        </div>
                        <div class="col-8">
                            <button class="btn btn-success btn-big" onclick="salvar()">SALVAR METRO</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <h6 class="ms-2 small text-muted">HISTÓRICO</h6>
            <div class="list-group" id="historico"></div>
        </div>
    </div>

    <div class="modal fade" id="modalFim" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Nível D'água</h5></div>
                <div class="modal-body">
                    <label>Inicial (m)</label><input type="number" id="na_ini" class="form-control input-big mb-3">
                    <label>Final 24h (m)</label><input type="number" id="na_fim" class="form-control input-big mb-3">
                    <button class="btn btn-dark btn-big" onclick="salvarFim()">SALVAR E SAIR</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let obraId, furoId, nextProf=1;

        function mostrar(tela) { document.querySelectorAll('.tela').forEach(t=>t.classList.remove('ativa')); document.getElementById(tela).classList.add('ativa'); }
        function voltar(tela) { if(tela==='tela-obras') carregarObras(); mostrar(tela); }

        function carregarObras() {
            fetch('/api/propostas').then(r=>r.json()).then(d=>{
                const l = document.getElementById('lista-obras'); l.innerHTML='';
                d.forEach(o => l.innerHTML += `<div class="card card-obra shadow-sm" onclick="obra(${o.id}, '${o.cliente}')"><div class="card-body py-3 fw-bold">${o.cliente}</div></div>`);
            });
        }
        function obra(id, nome) { obraId=id; document.getElementById('titulo-obra').innerText=nome; mostrar('tela-furos'); carregarFuros(); }

        function carregarFuros() {
            fetch(`/api/boletim/furos/${obraId}`).then(r=>r.json()).then(d=>{
                const l = document.getElementById('lista-furos'); l.innerHTML='';
                d.forEach(f => l.innerHTML += `<div class="card mb-2 shadow-sm" onclick="furo(${f.id}, '${f.nome_furo}')"><div class="card-body py-3 d-flex justify-content-between fw-bold"><span>${f.nome_furo}</span><i class="bi bi-chevron-right"></i></div></div>`);
            });
        }
        function abrirNovoFuro() {
            const n = prompt('Nome (ex: SP-01):', 'SP-');
            if(n) fetch('/api/boletim/furos', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({proposta_id:obraId, nome_furo:n, sondador:'App', data_inicio:new Date(), nivel_agua_inicial:0})}).then(r=>r.json()).then(d=>furo(d.id, n));
        }
        function furo(id, nome) { furoId=id; document.getElementById('titulo-furo').innerText=nome; mostrar('tela-coleta'); dados(); }

        function dados() {
            fetch(`/api/boletim/amostras/${furoId}`).then(r=>r.json()).then(d=>{
                const l = document.getElementById('historico'); l.innerHTML='';
                let max=0;
                d.forEach(a=>{ max=parseFloat(a.profundidade_ini); l.innerHTML = `<div class="list-group-item d-flex justify-content-between"><strong>${max.toFixed(2)}m</strong><span>${a.golpe_1}/${a.golpe_2}/${a.golpe_3}</span></div>`+l.innerHTML; });
                nextProf = max+1; document.getElementById('prof-atual').innerText = `Próx: ${nextProf.toFixed(2)}m`;
                ['g1','g2','g3','solo'].forEach(i=>document.getElementById(i).value='');
            });
            fetch(`/api/boletim/furos/${obraId}`).then(r=>r.json()).then(d=>{
                const f = d.find(x=>x.id==furoId);
                if(f) { document.getElementById('na_ini').value=f.nivel_agua_inicial; document.getElementById('na_fim').value=f.nivel_agua_final; }
            });
        }

        function addSolo(t) { const s = document.getElementById('solo'); s.value = s.value ? s.value+' '+t.toLowerCase() : t; }
        
        function salvar() {
            const g1=document.getElementById('g1').value, g2=document.getElementById('g2').value, g3=document.getElementById('g3').value;
            if(!g1||!g2||!g3) return alert('Preencha os golpes');
            fetch('/api/boletim/amostras', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({furo_id:furoId, profundidade_ini:nextProf, profundidade_fim:nextProf+0.45, golpe_1:g1, golpe_2:g2, golpe_3:g3, tipo_solo:document.getElementById('solo').value})}).then(()=>dados());
        }

        function foto() {
            const f = document.getElementById('cam').files[0];
            if(f) {
                const r = new FileReader();
                r.onload = e => fetch('/api/boletim/fotos', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({furo_id:furoId, imagem_base64:e.target.result, legenda:`Prof: ${nextProf}m`})}).then(()=>alert('Foto Salva!'));
                r.readAsDataURL(f);
            }
        }

        function modalFim() { new bootstrap.Modal('#modalFim').show(); }
        function salvarFim() {
            fetch(`/api/boletim/furos/${furoId}`, {method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({nivel_agua_inicial:document.getElementById('na_ini').value, nivel_agua_final:document.getElementById('na_fim').value})}).then(()=>{ alert('Salvo!'); location.reload(); });
        }

        carregarObras();
    </script>
</body>
</html>