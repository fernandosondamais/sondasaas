<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SondaMais | App Campo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background: #eef2f5; padding-bottom: 100px; font-family: 'Segoe UI', sans-serif; }
        .header { background: #2c3e50; color: white; padding: 15px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .card-obra { border-left: 6px solid #8CBF26; margin-bottom: 15px; cursor: pointer; background: white; border-radius: 8px; }
        .card-obra:active { background: #f0f0f0; }
        .btn-action { height: 60px; width: 100%; border-radius: 12px; font-weight: bold; font-size: 1.2rem; margin-top: 15px; }
        .input-big { height: 65px; font-size: 1.5rem; text-align: center; font-weight: bold; }
        .tela { display: none; }
        .tela.ativa { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from {opacity:0} to {opacity:1} }
    </style>
</head>
<body>

    <div id="tela-obras" class="tela ativa">
        <div class="header d-flex justify-content-between align-items-center">
            <span class="fw-bold fs-5">Minhas Obras</span>
            <a href="/logout" class="text-white small text-decoration-none">Sair</a>
        </div>
        <div class="container mt-3" id="lista-obras">
            <div class="text-center mt-5">
                <div class="spinner-border text-success"></div>
                <p class="text-muted mt-2">Buscando cronograma...</p>
            </div>
        </div>
    </div>

    <div id="tela-furos" class="tela">
        <div class="header d-flex align-items-center gap-3">
            <i class="bi bi-arrow-left fs-2" onclick="voltar('tela-obras')"></i>
            <h6 class="m-0 text-truncate fw-bold" id="nome-obra">...</h6>
        </div>
        <div class="container mt-3">
            <div class="row g-2 mb-3">
                <div class="col-6">
                    <a id="link-waze" href="#" target="_blank" class="btn btn-outline-dark w-100 fw-bold"><i class="bi bi-geo-alt-fill text-danger me-1"></i> WAZE</a>
                </div>
                <div class="col-6">
                    <a id="link-tel" href="#" class="btn btn-outline-dark w-100 fw-bold"><i class="bi bi-whatsapp text-success me-1"></i> LIGAR</a>
                </div>
            </div>

            <button class="btn btn-success btn-action shadow" onclick="novoFuro()">
                <i class="bi bi-plus-circle me-2"></i> INICIAR FURO
            </button>
            
            <h6 class="mt-4 text-muted border-bottom pb-2">FUROS REALIZADOS</h6>
            <div id="lista-furos"></div>
        </div>
    </div>

    <div id="tela-coleta" class="tela">
        <div class="header d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-3">
                <i class="bi bi-arrow-left fs-2" onclick="voltar('tela-furos')"></i>
                <div>
                    <div class="fw-bold fs-5" id="nome-furo">SP-XX</div>
                    <span class="badge bg-warning text-dark" id="prox-metro">Metro: 1.0m</span>
                </div>
            </div>
            <button class="btn btn-outline-light btn-sm" onclick="modalFim()">Finalizar</button>
        </div>

        <div class="container mt-3">
            <div class="card shadow-sm border-0 p-3">
                <label class="fw-bold text-muted mb-2">GOLPES (30cm cada)</label>
                <div class="row g-2 mb-3">
                    <div class="col-4"><input type="tel" id="g1" class="form-control input-big bg-light" placeholder="1¬∫"></div>
                    <div class="col-4"><input type="tel" id="g2" class="form-control input-big bg-light" placeholder="2¬∫"></div>
                    <div class="col-4"><input type="tel" id="g3" class="form-control input-big bg-light" placeholder="3¬∫"></div>
                </div>

                <label class="fw-bold text-muted mb-2">SOLO / OBS</label>
                <textarea id="desc" class="form-control mb-3 p-3 fs-5" rows="2" placeholder="Ex: Argila vermelha..."></textarea>

                <div class="row g-2">
                    <div class="col-3">
                        <button class="btn btn-primary btn-action mt-0 h-100" onclick="document.getElementById('cam').click()">
                            <i class="bi bi-camera-fill fs-3"></i>
                        </button>
                        <input type="file" id="cam" accept="image/*" capture="environment" class="d-none" onchange="uploadFoto()">
                    </div>
                    <div class="col-9">
                        <button class="btn btn-success btn-action mt-0 h-100" onclick="salvarAmostra()">
                            SALVAR METRO <i class="bi bi-check-lg ms-2"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="historico" class="mt-3 list-group list-group-flush rounded shadow-sm"></div>
        </div>
    </div>

    <div class="modal fade" id="modalFim">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title">Dados Finais</h5>
                    <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label>N√≠vel D'√°gua (m)</label>
                        <input type="number" id="na_ini" class="form-control input-big">
                    </div>
                    <button class="btn btn-dark w-100 py-3 fw-bold" onclick="salvarFim()">ENCERRAR FURO</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let obraId, furoId, obraAtual = {};

        function mostrar(t) { document.querySelectorAll('.tela').forEach(x=>x.classList.remove('ativa')); document.getElementById(t).classList.add('ativa'); window.scrollTo(0,0); }
        function voltar(t) { if(t==='tela-obras') loadObras(); mostrar(t); }

        function loadObras() {
            fetch('/api/propostas').then(r=>r.json()).then(d=>{
                const l = document.getElementById('lista-obras'); l.innerHTML='';
                if(d.length === 0) l.innerHTML = '<div class="text-center text-muted mt-5">Nenhuma obra designada para voc√™.</div>';
                d.forEach(o => {
                    l.innerHTML += `
                    <div class="card card-obra shadow-sm p-3" onclick='entrarObra(${JSON.stringify(o)})'>
                        <h5 class="fw-bold mb-1 text-dark">${o.cliente}</h5>
                        <div class="text-muted mb-1"><i class="bi bi-geo-alt-fill text-danger"></i> ${o.endereco}</div>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <span class="badge bg-light text-dark border">Furos: ${o.furos_previstos}</span>
                            <span class="text-success small fw-bold">ABRIR <i class="bi bi-chevron-right"></i></span>
                        </div>
                    </div>`;
                });
            });
        }

        function entrarObra(obra) {
            obraId = obra.id;
            obraAtual = obra;
            document.getElementById('nome-obra').innerText = obra.cliente;
            
            // Configura Waze e Telefone
            document.getElementById('link-waze').href = `https://waze.com/ul?q=${encodeURIComponent(obra.endereco)}`;
            document.getElementById('link-tel').href = `tel:${obra.telefone || ''}`;
            
            mostrar('tela-furos');
            loadFuros();
        }

        function loadFuros() {
            fetch(`/api/boletim/furos/${obraId}`).then(r=>r.json()).then(d=>{
                const l = document.getElementById('lista-furos'); l.innerHTML='';
                d.forEach(f => {
                    l.innerHTML += `
                    <div class="card mb-2 shadow-sm" onclick="entrarFuro('${f.id}', '${f.nome_furo}')">
                        <div class="card-body py-3 d-flex justify-content-between align-items-center">
                            <span class="fw-bold fs-5 text-dark">üï≥Ô∏è ${f.nome_furo}</span>
                            <span class="text-muted small">${f.data_termino ? 'Finalizado' : 'Em andamento'}</span>
                        </div>
                    </div>`;
                });
            });
        }

        function novoFuro() {
            // Pega Geolocaliza√ß√£o
            if(confirm('Iniciar novo furo neste local?')) {
                navigator.geolocation.getCurrentPosition(pos => {
                    const coords = `${pos.coords.latitude}, ${pos.coords.longitude}`;
                    const n = prompt('Nome do Furo (Ex: SP-01):', 'SP-');
                    if(n) {
                        fetch('/api/boletim/furos', {
                            method:'POST', headers:{'Content-Type':'application/json'}, 
                            body:JSON.stringify({proposta_id:obraId, nome_furo:n, coordenadas:coords})
                        }).then(r=>r.json()).then(d=>entrarFuro(d.id, n));
                    }
                }, err => alert('Erro GPS: ative a localiza√ß√£o!'));
            }
        }

        function entrarFuro(id, nome) {
            furoId = id;
            document.getElementById('nome-furo').innerText = nome;
            mostrar('tela-coleta');
            loadAmostras();
        }

        function loadAmostras() {
            fetch(`/api/boletim/amostras/${furoId}`).then(r=>r.json()).then(d=>{
                const l = document.getElementById('historico'); l.innerHTML='';
                let max = 0;
                d.forEach(a => {
                    if(parseFloat(a.profundidade_ini) > max) max = parseFloat(a.profundidade_ini);
                    l.innerHTML = `
                    <div class="list-group-item d-flex justify-content-between">
                        <div><span class="fw-bold">${a.profundidade_ini}m</span> <small class="text-muted">${a.tipo_solo}</small></div>
                        <span class="font-monospace fw-bold bg-light px-2 rounded border">${a.golpe_1}-${a.golpe_2}-${a.golpe_3}</span>
                    </div>` + l.innerHTML;
                });
                document.getElementById('prox-metro').innerText = `Pr√≥ximo: ${max + 1}.0m`;
                ['g1','g2','g3','desc'].forEach(i=>document.getElementById(i).value='');
            });
        }

        function salvarAmostra() {
            // ... (Mesma l√≥gica de antes, s√≥ valida√ß√£o)
            const g1 = document.getElementById('g1').value;
            if(!g1) return alert('Preencha os dados!');
            // Pega o metro atual do texto do badge
            const metroTxt = document.getElementById('prox-metro').innerText.replace('Pr√≥ximo: ','').replace('.0m','');
            const prof = parseFloat(metroTxt);

            fetch('/api/boletim/amostras', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body:JSON.stringify({
                    furo_id: furoId, profundidade_ini: prof, profundidade_fim: prof+1,
                    golpe_1: document.getElementById('g1').value,
                    golpe_2: document.getElementById('g2').value,
                    golpe_3: document.getElementById('g3').value,
                    tipo_solo: document.getElementById('desc').value
                })
            }).then(() => { alert('Salvo!'); loadAmostras(); });
        }

        function modalFim() { new bootstrap.Modal('#modalFim').show(); }
        function salvarFim() {
            fetch(`/api/boletim/furos/${furoId}`, {
                method:'PUT', headers:{'Content-Type':'application/json'},
                body:JSON.stringify({
                    nivel_agua_inicial: document.getElementById('na_ini').value,
                    data_termino: new Date()
                })
            }).then(() => { alert('Furo Finalizado!'); voltar('tela-furos'); });
        }

        // Init
        loadObras();
    </script>
</body>
</html>