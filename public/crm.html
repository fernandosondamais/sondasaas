<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>CRM - Gest√£o de Equipes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f5f7; font-family: sans-serif; }
        .board { display: flex; gap: 15px; padding: 20px; overflow-x: auto; height: 90vh; }
        .column { background: #ebecf0; min-width: 320px; width: 320px; border-radius: 8px; padding: 10px; display: flex; flex-direction: column; }
        .card-item { background: white; padding: 12px; margin-bottom: 10px; border-radius: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.15); cursor: grab; }
        .select-equipe { font-size: 0.8rem; padding: 2px; border: 1px solid #ccc; border-radius: 4px; width: 100%; margin-top: 5px; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark px-3 shadow">
        <a class="navbar-brand" href="/admin">üîô Painel</a>
        <span class="navbar-text text-white fw-bold">Gest√£o de Equipes & Obras</span>
        <a href="/logout" class="btn btn-sm btn-outline-danger">Sair</a>
    </nav>

    <div class="board">
        <div class="column" ondrop="drop(event, 'ORCAMENTO')" ondragover="allowDrop(event)">
            <h6 class="fw-bold p-2 text-secondary">Or√ßamentos</h6>
            <div id="col-orcamento" style="flex-grow: 1;"></div>
        </div>
        <div class="column" ondrop="drop(event, 'Aprovada')" ondragover="allowDrop(event)">
            <h6 class="fw-bold p-2 text-success">Aprovadas (Escalar Equipe)</h6>
            <div id="col-aprovada" style="flex-grow: 1;"></div>
        </div>
        <div class="column" ondrop="drop(event, 'Em Execu√ß√£o')" ondragover="allowDrop(event)">
            <h6 class="fw-bold p-2 text-primary">Em Execu√ß√£o</h6>
            <div id="col-execucao" style="flex-grow: 1;"></div>
        </div>
        <div class="column" ondrop="drop(event, 'Finalizada')" ondragover="allowDrop(event)">
            <h6 class="fw-bold p-2 text-dark">Finalizadas</h6>
            <div id="col-finalizada" style="flex-grow: 1;"></div>
        </div>
    </div>

    <script>
        let sondadores = [];

        async function init() {
            // 1. Busca lista de sondadores
            const r = await fetch('/api/usuarios/sondadores');
            sondadores = await r.json();
            carregarBoard();
        }

        async function carregarBoard() {
            const res = await fetch('/api/propostas');
            const data = await res.json();
            
            document.querySelectorAll('.column > div').forEach(el => el.innerHTML = '');

            data.forEach(p => {
                const statusMap = {'ORCAMENTO': 'col-orcamento', 'Em Aberto': 'col-orcamento', 'Aprovada': 'col-aprovada', 'Em Execu√ß√£o': 'col-execucao', 'Finalizada': 'col-finalizada'};
                const destino = statusMap[p.status] || 'col-orcamento';
                
                const card = document.createElement('div');
                card.className = 'card-item border-start border-4 ' + (p.status==='Aprovada'?'border-success':'border-secondary');
                card.draggable = true;
                card.ondragstart = (ev) => ev.dataTransfer.setData("text", p.id);

                // Monta Dropdown de Equipe
                let options = `<option value="">-- Sem Equipe --</option>`;
                sondadores.forEach(s => {
                    options += `<option value="${s.id}" ${p.sondador_id === s.id ? 'selected' : ''}>üë∑ ${s.nome}</option>`;
                });

                card.innerHTML = `
                    <div class="fw-bold text-dark">${p.cliente}</div>
                    <div class="small text-muted mb-2 text-truncate">üìç ${p.endereco}</div>
                    
                    ${ (p.status === 'Aprovada' || p.status === 'Em Execu√ß√£o') ? 
                        `<div class="bg-light p-2 rounded">
                            <label class="small fw-bold text-muted">Equipe Respons√°vel:</label>
                            <select class="select-equipe" onchange="atribuirEquipe('${p.id}', this.value)">
                                ${options}
                            </select>
                        </div>` : '' 
                    }
                    
                    <div class="text-end mt-2">
                        <a href="/engenharia?id=${p.id}" class="btn btn-sm btn-outline-primary py-0" style="font-size: 0.75rem;">Engenharia üèóÔ∏è</a>
                    </div>
                `;
                document.getElementById(destino).appendChild(card);
            });
        }

        async function atribuirEquipe(id, sondadorId) {
            await fetch(`/api/propostas/${id}/equipe`, {
                method: 'PATCH', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ sondador_id: sondadorId })
            });
            // Feedback visual simples
            alert('Equipe escalada com sucesso!');
        }

        function allowDrop(ev) { ev.preventDefault(); }
        async function drop(ev, novoStatus) {
            ev.preventDefault();
            const id = ev.dataTransfer.getData("text");
            await fetch(`/api/propostas/${id}/status`, {
                method: 'PATCH', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ status: novoStatus })
            });
            carregarBoard();
        }

        init();
    </script>
</body>
</html>