<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Gest√£o</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f5f7; font-family: sans-serif; padding-bottom: 60px; }
        /* Layout Mobile Friendly */
        .board { display: flex; gap: 15px; padding: 15px; overflow-x: auto; min-height: 85vh; }
        .column { background: #ebecf0; min-width: 85vw; /* Ocupa quase toda tela no mobile */ border-radius: 8px; padding: 10px; display: flex; flex-direction: column; }
        @media (min-width: 768px) { .column { min-width: 320px; width: 320px; } }
        
        .card-item { background: white; padding: 15px; margin-bottom: 12px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .select-equipe { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; margin-top: 5px; background: white; }
        .status-select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; margin-top: 10px; background: #fff3cd; font-weight: bold; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark px-3 sticky-top shadow-sm">
        <a class="navbar-brand text-truncate" href="/admin">üîô Painel</a>
        <span class="navbar-text text-white small">Gest√£o de Obras</span>
    </nav>

    <div class="board">
        <div class="column">
            <h6 class="fw-bold p-2 text-secondary border-bottom">OR√áAMENTOS</h6>
            <div id="col-orcamento"></div>
        </div>
        <div class="column">
            <h6 class="fw-bold p-2 text-success border-bottom">APROVADAS (Escalar)</h6>
            <div id="col-aprovada"></div>
        </div>
        <div class="column">
            <h6 class="fw-bold p-2 text-primary border-bottom">EM EXECU√á√ÉO</h6>
            <div id="col-execucao"></div>
        </div>
        <div class="column">
            <h6 class="fw-bold p-2 text-dark border-bottom">FINALIZADAS</h6>
            <div id="col-finalizada"></div>
        </div>
    </div>

    <script>
        let sondadores = [];

        async function init() {
            const r = await fetch('/api/usuarios/sondadores');
            sondadores = await r.json();
            carregarBoard();
        }

        async function carregarBoard() {
            const res = await fetch('/api/propostas');
            const data = await res.json();
            
            document.querySelectorAll('.column > div').forEach(el => el.innerHTML = '');

            data.forEach(p => {
                const statusMap = {'ORCAMENTO': 'col-orcamento', 'Em Aberto': 'col-orcamento', 'Aprovada': 'col-aprovada', 'Em Execu√ß√£o': 'col-execucao', 'Finalizada': 'col-finalizada'};
                const destino = statusMap[p.status] || 'col-orcamento';
                
                const card = document.createElement('div');
                card.className = 'card-item border-start border-4 ' + (p.status==='Aprovada'?'border-success':'border-secondary');

                // Dropdown de Equipe
                let options = `<option value="">-- Selecione a Equipe --</option>`;
                sondadores.forEach(s => {
                    options += `<option value="${s.id}" ${p.sondador_id === s.id ? 'selected' : ''}>${s.nome}</option>`;
                });

                // Dropdown de Status (Para mobile, substitui Drag&Drop)
                let statusOptions = '';
                ['ORCAMENTO', 'Aprovada', 'Em Execu√ß√£o', 'Finalizada'].forEach(st => {
                    statusOptions += `<option value="${st}" ${p.status === st ? 'selected' : ''}>Mover para: ${st}</option>`;
                });

                // S√≥ mostra seletor de equipe se estiver aprovada/execu√ß√£o
                const showTeam = (p.status === 'Aprovada' || p.status === 'Em Execu√ß√£o');

                card.innerHTML = `
                    <div class="fw-bold text-dark fs-5">${p.cliente}</div>
                    <div class="text-muted mb-2"><small>üìç ${p.endereco}</small></div>
                    
                    ${ showTeam ? `
                        <div class="bg-light p-2 rounded mb-2">
                            <label class="small fw-bold text-muted">Respons√°vel:</label>
                            <select class="select-equipe" onchange="atribuirEquipe('${p.id}', this.value)">${options}</select>
                        </div>` : '' 
                    }

                    <label class="small fw-bold text-muted mt-2">Status da Obra:</label>
                    <select class="status-select" onchange="mudarStatus('${p.id}', this.value)">${statusOptions}</select>
                    
                    <div class="text-end mt-3 pt-2 border-top">
                        <a href="/engenharia?id=${p.id}" class="btn btn-outline-primary btn-sm w-100 fw-bold">VER DADOS T√âCNICOS</a>
                    </div>
                `;
                document.getElementById(destino).appendChild(card);
            });
        }

        async function atribuirEquipe(id, sondadorId) {
            await fetch(`/api/propostas/${id}/equipe`, {
                method: 'PATCH', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ sondador_id: sondadorId })
            });
            alert('Equipe atualizada!');
        }

        async function mudarStatus(id, novoStatus) {
            await fetch(`/api/propostas/${id}/status`, {
                method: 'PATCH', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ status: novoStatus })
            });
            carregarBoard();
        }

        init();
    </script>
</body>
</html>